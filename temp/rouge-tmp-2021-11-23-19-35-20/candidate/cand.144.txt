All of the many other queries of the bots will result in nonexistent domain (NXD) responses.1 https://dgarchive.caad.fkie.fraunhofer.de/ In the past, monitoring DNS traffic (successfully resolving and/or non-resolving) has been used as primary or additional source of information in detecting malicious activity in a network (e.g., [2,16,18,9,4]). While these prior works show promising detection capabilities, little information on the efficiency of the detection process in terms of time and memory requirements is reported.This work presents FANCI: Feature-based Automated NXDomain Classification and Intelligence, a novel system for detecting infections with DGA-based malware by monitoring NXD responses. Other contextual information extracted from the full NXD response that carried the domain name, from other related DNS responses, or from any other source are not required.We extensively evaluate FANCI's classification module on malicious data obtained from DGArchive [14] and data recorded in the campus network of RWTH Aachen University 2 , and in the internal network of the Siemens AG 3 . Finally, our system is very efficient with respect to both training (5.66 min on 92,102 samples) and prediction (0.0025 s per sample) such that it is even able to perform on-thefly detection in large networks without sampling.FANCI's lightweight feature design and its generalizability allows for versatile application scenarios, including the use of its classification as a service, and its use in large-scale networks as well as on home-grade hardware. For example, anti-virus software performing signature checks [17] or Google Chrome, which uses random domain names to probe its DNS environment and detect DNS hijacking attempts [19]. In our work, we focus on supervised learning classifiers, more specifically on random forests (RFs) and support vector machines (SVMs) using the two labels benign and malicious. In particular, we get rid of all features used in previous work that require additional contextual information without loss of (in fact rather increasing) accuracy (see Section 6). Features ignoring both operate on a string referred to as dot-free public-suffix-free5 https://publicsuffix.org # Feature Output F (d 1 ) F (d 2 )1 Domain Name Length integer 19 34 2 † Number of Subdomains integer 2 2 3 † Subdomain Length Mean rational 7.5 25 4 Has www Prefix binary 0 0 5 Has Valid TLD binary 1 1 domain and denoted by d ds f . As benign domain names have to select public suffixes from the exact same pool of officially available public suffixes, a public suffix offers no valuable additional information to distinguish mAGDs from bNXDs. de and d 2 = dekh1her76avy0qnelivijwd1.ddns.net, where d 1 is benign and d 2 is a known mAGD.In the following, we discuss the non-self-explanatory structural features #7, #9, #10, and #12 in more detail. de this feature evaluates to 3/12, where repeating characters in d ds f are n, h, and a. # Feature Output F (d 1 ) F (d 2 ) 20 * † N-Gram Dist. We obtain labeled mAGDs for training purposes from DGArchive. The classification module operates on an NXD, that is, on an individual domain name as input submitted for classification either by an intelligence module (see Section 4.3) or by any other source as indicated with a dashed arrow in Figure 3. As opposed to the classification module, which only takes the NXD itself as input, the intelligence module additionally takes the source and destination IP address and the timestamp of each NXD response as input in order to be able to map a malicious label as classification result back to the device that initiated the query.In a first preprocessing step this module extracts the domain name and the aforementioned meta data from an NXD response. The first case considers the usage of FANCI with all of its three modules at a single operation site, while the second case takes advantage of FANCI's modular design and considers a distributed use of FANCI. In such a deployment the previously trained model is used to label NXDs and to provide insights about infected devices to network administrators and incident handlers.In some networks (e.g., in a typical university network) DNS traffic of devices can be monitored in a way such that IP addresses of querying devices are visible. FANCI could also be integrated into existing monitoring software and can significantly add value to its detection capabilities by providing directly utilizable threat intelligence. For example, this can be small networks (e.g., those of small businesses), where it takes too long to get the necessary amount of data for training or this can be networks, where it is a non-trivial task to obtain a clean set of bNXDs for supervised learning (e.g., ISP networks). We obtained data of a two-month period from September and October 2017 (i.e., 61 days) comprising 31.2 million unique NXDs overall.The long recording periods for both benign data sets guarantee a representative data set including different times of the day, different days of the week, and working and non-working days. We were able to obtain mAGD data for 1,344 days, ranging from 12 February 2014 until 30 January 2018. As our selected ML algorithms at least need a set size of a few hundred NXDs to perform well, we decided to reduce the set by eliminating all DGAs with less than 250 unique mAGDs. An LOGO CV is in its basic procedure similar to a k-fold CV, but instead of building k random folds, the folds are defined regarding a predefined grouping, for example, by seeds or DGAs.We determined the optimal parameter settings for the ML algorithms for two different scenarios with the help of extensive grid searches on data sets independent of the ones used for evaluation. In all experiments, we consider accuracy (ACC) as primary metric to characterize a classifier's performance defined as ACC = |T P| + |T N|/|population|, where |T P| is the amount of true positives and |T N| the amount of true negatives. In this experiment, we focus on evaluating the detection of mAGDs generated by a DGA with a new seed, where the model is trained with mAGDs generated by the same DGA using known seeds.To evaluate this scenario we perform an LOGO CV, that is, we perform training with mAGDs of all but one seed of a certain single DGA, perform prediction on the skipped one, and repeat this procedure for each seed and DGA. In total, this results in 5 · 550 = 2750 iterations for all available seeds and DGAs.A statistical summary of the evaluation results for this experiment for RFs is depicted in Table 5 Table 6: Results for detecting mAGDs with RFs of arbitrary mixed DGAs using 5 repetitions of 5-fold CV for each set. For each of these 20 sets we performed 5 repetitions of a 5-fold CV.In its trend, results for detecting mAGDs in sets containing mAGDs of multiple DGAs are similar to the detection of using dedicated classifiers for each single DGAs as presented previously. Next, we carry out two experiments proving that our trained classifiers generalize well to unknown networks, that is, we examine the scenario of training a classifier using data from a certain network but use this classifier somewhere else. However, the false negatives (FNs) even decrease.Mixed DGAs, Training Siemens, Prediction RWTH Table 10 shows results for considering sets containing bNXDs from Siemens for training and bNXD data from RWTH Aachen for prediction. As we use a local specific whitelist in the second filtering step, we consider two data sets, one for RWTH Aachen FP bNXDs (6,522) and one for Siemens FP bNXDs (11,431). Considering the Siemens network, we reduce the FPs at least by 47.85 percent resulting in 5,961 domains and in the best case we reduce the FPs by 77.74 percent yielding 2,544 domains left.The results clearly show the efficiency of our subsequent FP filtering. For our real world application test of FANCI we consider a fresh one-month recording from the central DNS resolver of RWTH Aachen University comprising 31 days, more precisely from 13 October 2017 until 12 November 2017, where the data amount is similar to the recording from Section 5.1. We carried out the labeling of the groups with the help of DGArchive, domain knowledge, and manual research.By implication, we have seen at most 22,345 unique FPs in our one-month, real-world test resulting in a worst-case FPR of approximately 0.00064. Where human-generated NXDs usually exhibit natural language patterns or are very sim- Considering the fact that we only require to process successfully resolved domains of single devices or small groups of devices, the previously presented approach is highly promising for performing identification of C2 servers. Some of these approaches have concentrated on identifying C2 servers (e.g., [18,16]), others have focused on detecting mAGDs (e.g., [2]), identifying infected devices (e.g., [9]), or detecting malicious URLs in general (e.g., [4]). However, monitoring only NXD responses has the advantage that infections with bots can be detected with less delay and while processing significantly less traffic as the vast majority of DGAs issue many more NXDs than registered names.While the prior works show promising detection capabilities on specific data sets, little information on their generalizability and the efficiency of their detection process in terms of time and memory requirements is reported. FANCI is highly efficient with respect to both prediction (0.0025s/sample) and training (5.66min on 92102 samples) and shows a high accuracy with low FPR in very large scale realistic scenarios even when trained on a different network.A fair comparison between FANCI and the prior approaches with respect to detection accuracy and efficiency is hard to achieve as they aim at slightly different targets and use different data sets even if they do aim at the same target. This filtering requires access to the overall successfully resolving DNS traffic (in order to count the number of domains that resolve to a given IP address), NXD responses in the vicinity of successful queries, as well as the entropy of failed and successful DNS queries. However, Phoenix is also capable of labeling DNS traffic as either DGA-related or benign.They evaluated the classification performance of Phoenix on 1,153,516 domains overall including mAGDs of three different DGAs and bNXDs obtained from a passive DNS. They assume that a DGA malware infected device is characterized by regularly issuing DNS requests without subsequent connections to new IP addresses.For their evaluation they performed three experiments considering different types of hosts, network sizes, and times of the day. Their paper is based on the collection and reverse engineering of DGA-based malware and provides detailed technical insights in the functionality of modern DGAs divisible in three main contributions: a taxonomy of DGAs, a database of DGAs and corresponding mAGDs called DGArchive, and an analysis of the landscape of registered mAGDs. If such a successful query can be detected (e.g., by using FANCI on the successful queries of infected devices after their identification), this reveals the IP address of a C2 server for the botnet in question.We therefore present a preliminary evaluation of how well FANCI is able to separate mAGDs from success- This section presents a brief overview of training and classification speeds to demonstrate FANCI's realworld applicability.