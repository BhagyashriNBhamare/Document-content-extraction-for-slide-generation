We present a full implementation of DELEGATEE using Intel SGX and demonstrate its use in four real-world applications: email access (SMTP/IMAP), restricted website access using a HTTPS proxy, e-banking/credit card, and a third-party payment system (PayPal). Brokered delegation is a new and powerful tool that allows users to flexibly share and delegate access, without requiring the explicit support (or even knowledge) of the service providers.To demonstrate the potential of brokered delegation, we design DELEGATEE, a system that provides brokered delegation for many existing web services according to complex contextual access-control policies. We develop several application prototypes to demonstrate how brokered delegation can support new forms of resource sharing and give rise to new markets: secure outsourcing of personal and commercial microtasks, tokenization (i.e., creation of fungible, tradeable units), resale of resources and services, and new payment methods -all without changes to the legacy infrastructure. For example, reselling limited access to a paid subscription service in regions where the service is unavailable undermines the service's security policy, while delegating access to office tools such as mail, calendar, etc. to administrative assistants can enrich the capabilities and usability of the service itself. These include a desire to delegate work to administrative assistants (e.g., read-only access, send mail only to a specific domain) or to allow limited access to law-enforcement authorities (e.g., read emails from a certain time window relevant to a court case). This can have large benefits in terms of cost-saving, business operations, and anonymity guarantees.Imagine that a company wants to allow its employees to execute online purchases with the company credit card or PayPal, but restricted to a certain limit per expenditure and specific merchants. They could also sell space in their social networking accounts to advertisers; e.g., a user could sell the ability to post in her name, enabling an advertiser to target her social network. The first is that the Owner remains online and mediates requests, which forecloses on the possibility of private transactions or her inability to provide continuous service availability.The second is that the Owner provides the Delegatee with a digital resource for unmediated access to the target resource. The SGX architecture enables the app developer to create multiple enclaves for security-critical code, protecting it from malicious applications [43], a compromised OS, virtual machine manager [11], or BIOS [24], and even insecure hardware [16] on the same system. The signing key used by the Quoting Enclave is based on a group signature scheme called EPID (Enhanced Privacy ID) which supports two modes of attestation: fully anonymous and linkable attestation using pseudonyms [22,13]. Both architectures involve three distinct classes of parties: credential Owner(s) A, Delegatee(s) B, and service(s) G. Additionally, the system distinguishes 2 data types: credential(s) C and access control policy(ies) P. Owners and Delegatees are generically referred to as users.The system supports a potentially large population of credential Owners A 1 ...A n (henceforth referred to as Owners) and Delegatees B 1 ...B n . Alternatively to the P2P configuration, the Centrally Brokered system consists of a central server that mediates all transactions and communication between the involved parties and also serves as a management entity. (4) During the agreement, users exchange their unique identifiers (i.e. system username) so that the Owner from party A knows whom to authorize from party B.(5) The Owner A i establishes a secure channel to the system, specifies for which credentials (C x ) she wants to perform the delegation, for which service (G k ) and to whom (username of B j ), while she additionally specifies the access control policy P i jxk that restricts usage. Owners may identify themselves with pseudonyms, e.g., onion addresses.In the P2P model, the bulletin board can be hosted on a third-party website, while the protocol runs through Tor Hidden Services, thereby ensuring privacy protection for both the Owner and Delegatee. Additionally, the Owner can rate-limit emails sent within a time interval, applying a spam and abuse filter for outgoing messages.In payments, the main restriction is on limiting the allowed amount per transaction or the total amount using the delegated credential for either a credit card or any other third party payment service. Additionally, the DELEGATEE can enforce restrictions on the source, limiting the Delegatee to perform payments only on specific sites or identified merchants/services, and white-listed geographical locations based on the IP address.In the full website access, DELEGATEE implements limiting the use of login credentials to specific sites (e.g., the Owner can have the same credentials for two different services. As work in progress, the policies are expanded to restrict specific actions on sites after the login, including, clicks on various links, loading of specific site content or access to the account settings.Our prototype implements delegation policies targeted at particular services, directly in C++. Hence all three security properties are ensured as long as the service's own software stack is not accessible to the attacker, regardless of any forged TEE attestations the attacker may produce or if the attacker can guess the SGX keys used by the enclave.We also avoid the use of persistent encrypted storage in the P2P model, thus, preventing potential rollback attacks [32], which may otherwise occur if the enclave's sealing keys can be derived by the attacker. So far our security analysis has Enclave type Core mbedtls Total API 4.0 (7.3%) 51.0 (92.7%) 55.0 Mail 1.9 (3.6%) 51.0 (96.4%) 52.9 Paypal 2.6 (4.9%) 51.0 (95.1%) 53.6 CreditCard 2.5 (4.7%) 51.0 (95.3%) 53.5 HTTPS Proxy 2.7 (5.0%) 51.0 (95.0%) 53.7 Table 1: TCB of DELEGATEE in LoC (thousands). The small number of calls and the small TCB, as shown in Table 1, facilitate code verification and reduce the surface area that may be affected by vulnerabilities.To demonstrate our use cases, we implemented four service specific enclaves for delegated use of mail, PayPal, credit card/e-banking, and full website access through an HTTPS proxy. If everything checks out, the API responds with the details of C x and P i jxk and the proxy enclave fills the login form before forwarding it to the website. Table 3 shows that the proxy adds the biggest latency overhead compared to normal browsing but still below 0.1 seconds for small to medium websites, a response time limit for seamless user interaction [35]. In this section we explore limitations of DELEGATEE, mainly focusing on how brokered delegation faces technical challenges in the authentication process, as well as business and regulatory challenges arising from users controlling their own resources in a more flexible and fine-grained way than service providers intend.Authentication challenges. Some of these can be supported with DEL-EGATEE, such as, email challenges or 2FA apps that could run inside the enclave as well, while for some, e.g. phone challenges, DELEGATEE cannot overcome the challenge.Contextual factors often additionally come into play, such as the IP address, time of day, and nature of service requests. However, for the P2P model, since the enclave resides on the Delegatees themselves, a single Owner can support multiple delegation of his, e.g. Netflix account (at least based on the limit of Netflix itself -2 or 4 devices based on the subscription). Those underground markets have met with two responses, sometimes used in tandem: (1) providers aim to detect facilitators of secondary markets and penalize or ban them, and (2) providers themselves seek to capture the revenue streams generated by secondary markets; e.g., online role-playing game providers have offered virtual goods for sale through their own shops [31]. It is, therefore, used to retrofit delegation for existing web services, without requiring additional effort (or even explicit support) from the provider.Many web services like Facebook, and Twitter, support delegation for third-party applications typically using OAuth or OpenID (e.g., a user may delegate to a Facebook app the authority to read her friends-list but not to post new messages on her behalf). Our browser extension simplifies the use of delegated PayPal credentials by adding a DELEGATEE checkout button next to the original PayPal checkout button if the Delegatee is logged in to our system and has some delegated credentials. Credentials in DELEGATEE are never revealed to Delegatees and Owners can restrict access to their accounts using a range of rich, contextually dependent delegation policies. The steps to execute secure credential delegation, also given in Figure 1, are:(1) The Owner A i agrees directly with the Delegatee B j for which specific service (G k ) access will be granted using her credentials (C x ). We assume that an attacker neither corrupts the full software stack of the Owner's and Delegatee's machines (unless the Delegatee is the attacker), nor the online service, as existing web authentication mechanisms rely on them anyway. Normally the payment process relies on a javascript library but running a javascript interpreter in Intel SGX would bloat the TCB, and create potential vulnerabilities associated with running an unmeasured, externally provided script inside an enclave. Figure 3c shows the detailed architecture and the steps follow bellow:(1) The Delegatee B j wants to buy something from a merchant using some credentials C x containing credit card or e-banking information that have been delegated by A i . Intel SGX has been proposed for a number of applications, including confidential map-reduce tasks [37], trustworthy data feeds for blockchain oracles [45] and retrofitting of legacy applications [7], secure payment channels [30], etc. Users can thus share their subscriptions by sharing credentials, but only in a dangerous all-or-nothing manner. For secure browsing we implemented a HTTPS proxy enclave. Consider, for example, a payment system where the users pay using each others' bank accounts, credit cards, or third-party providers (e.g., PayPal). Since the Owner only sends her credentials along this channel directly to the enclave, it is never exposed to the Delegatee's host machine, thereby ensuring property (a). Second, using chains of cryptographic assertions or certificates (as in X.509 or SPKI/SDSI), which can be digitally signed and communicated without interacting with a central server [10,15,34,8,6]. More recent work involves the delegation of private keys for cryptocurrencies in order to secure a payment channel [30]. To guarantee repayment, Sofort requires users to share their e-banking credentials with the service, a practice that clearly raises security and privacy risks.Finally, delegation of payments can benefit "underbanked" populations with limited access to online payment systems, by enabling them to leverage social ties (e.g., via brokered delegation to the bank accounts of friends, family, and peers). To log into a service using delegated credentials we leverage similar technologies as in the HTTPS proxy and we thus only extended the proxy enclave to support delegated authentication for websites. The only way the Delegatee can make use of the credentials is by providing commands as input to the enclave (all access is proxied through the enclave), where they are processed according to the access control policy P i jxk , ensuring the enforcement of (b). In Section 5 we outline a solution for an additional authentication method in form of a CAPTCHA, that is required by some online services.To illustrate, consider a scenario in the P2P mode where an Owner Alice (an inhabitant of the U.S.) delegates a password to DELEGATEE and allows her PayPal account to be rented. More fine-grained, e.g., service-specific, and secure delegation could facilitate much broader sharing (for good and bad). Financial services, e.g., PayPal, have particularly sophisticated fraud detection regimes; e.g., ordering unusual products with Paypal may trigger a fraud alert. We first describe how these properties are ensured assuming the TEE enclaves are secure, even if the software stack of the Centrally Brokered system is compromised.In the Centrally Brokered architecture, the TEE guarantees security properties (a) and (b) even if the central broker and the Delegatee are otherwise corrupted. For every specific service category, and sometimes even for every specific service provider in the same category, a new policy must be created that resembles the exact capabilities and actions which a fully allowed user may invoke. In the Centrally Brokered system, we do presume that the attacker has no presence on the full software stack, thus, for continuous operation of the system we make use of the persistent encrypted storage. In these implementation details we presume that the Owner A i and Delegatee B j already registered to the system and that the Owner authorized the Delegatee by storing the credentials C x and defining the access policy P i jxk for a specific service. The code and data of an enclave are stored in a protected memory area called Enclave Page Cache (EPC) that resides in Processor Reserved Memory (PRM) [33]. (c) Use of the credentials should only be granted to the intended Delegatee, as authorized by the Owner.The DELEGATEE system is designed to provide these security guarantees even against a strong attacker model. First, the credential Owner can interact with an authentication service to mint new credentials or tokens (representations of capabilities) for the Delegatee (e.g., Active Directory, Kerberos, and Oauth [17,18]). Our work aims to change this situation fundamentally -DELEGATEE empowers users to delegate their authority, making use of any existing internet service, such that:â€¢ The Owner's credentials remain confidential. However if a rogue Delegatee colludes with an attacker that can forge TEE attestations, or if the Delegatee's software stack is fully compromised, then the credentials would be forfeit.Our Centrally Brokered architecture is also designed with end-to-end authentication to mitigate against a potentially compromised TEE. One of the key features of DELEGATEE is that it requires no changes to the service managing the resource or to users' accounts.We present two design variations for DELEGATEE. One appealing example from the academic world is Sci-Hub. We also conducted tests in the real PayPal environment using the Centrally Brokered system, executing a real payment and buying an item online with a merchant supporting PayPal. If Alice is unava