Many computer vision problems can be formulated in a Bayesian framework based on Markov Random Fields (MRF) or Conditional Random Fields (CRF).
Generally, the MRF/CRF model is learned independently of the inference algorithm that is used to obtain the final result.
In this paper, we observe considerable gains in speed and accuracy by training the MRF/CRF model together with a fast and suboptimal inference algorithm.
An Active Random Field (ARF) is defined as a combination of a MRF/CRF based model and a fast inference algorithm for the MRF/CRF model.
This combination is trained through an optimization of a loss function and a training set consisting of pairs of input images and desired outputs.
We apply the Active Random Field concept to image denoising, using the Fields of Experts MRF together with a 1-4 iteration gradient descent algorithm for inference.
Experimental validation on unseen data shows that the Active Random Field approach obtains an improved benchmark performance as well as a 1000-3000 times speedup compared to the Fields of Experts MRF.
Using the ARF approach, image denoising can be performed in real-time, at 8fps on a single CPU for a 256×256 image sequence, with close to state-of-the-art accuracy.
Many real-world applications can be regarded as graphbased optimization problems, where the graph nodes are some smaller granularities of the system, such as atoms for material science and pixels for computer vision.
In some cases (e.g. material science), a unique energy function that can be described mathematically exists and can accurately represent the relationship between the graph nodes.
In computer vision, the natural images exhibit very complex structures for which it is difficult if not impossible to find an exact mathematical model that is computationally feasible.Many of these computer vision problems are approached by constructing models based on Markov Random Field (MRF) or Conditional Random Field (CRF) energy functions and obtaining the solution through an optimization procedure.
The optimization is one of the available MRF/CRF Maximum A Posteriori (MAP) inference algorithms such as gradient descent, Belief Propagation [44], Graph Cuts [5], Iterated Conditional Modes [3], etc.
However, such an approach faces two challenges when applied to real-world problems.First, the energy function must be computationally feasible in the sense that the minimum should be found in polynomial time.
This does not usually happen in reality, since finding the global minimum for most energy functions associated to realworld applications is NP hard.
For example, finding the global minimum of the Potts model [28], used in Stereo Matching as a prior term [5], [31], [32], is NP hard [5].
In such cases, polynomial-time algorithms are not expected to be found.Second, it is very hard to find energy functions that always have a global minimum exactly at the desired solution.
For example, even though the Potts model has been widely used in Stereo, the energy level of the desired result is higher than the energy obtained by different optimization algorithms [32], or the global minimum [23].
Recent work [1], [19], [20], [34], [35] introduced methods for training the MRF parameters such that the MRF energy minimum is as close as possible to the desired output on a training set.The goal of this paper is to observe that when an approximate model is sought, it is sometimes not necessary to find the global minimum of the MRF energy.
It has been shown in [39] that for applications with limited computational budget, the MAP parameter estimation does not give the best accuracy, and training biased estimators could compensate some of the errors introduced by the fast and approximate inference algorithm.
How much can the biased estimators compensate for the suboptimal algorithm?
In this paper we attempt to answer this question for image denoising with a target on real-time performance.
The energy model and the inference algorithm are no longer independent, so we consider them as parts of an Active Random Field, and their parameters are learned so that they work best together to obtain the desired results.
For the image denoising application, we use the Fields of Experts [29] Markov Random Field (MRF) model and a 1-4 iteration gradient descent inference algorithm.
The algorithm is restricted to be 1000-3000 times faster than the one previously used for image denoising and the best model-algorithm parameters are trained using a dataset of training pairs consisting of input images corrupted with noise and the desired denoised output (the images without the noise).
A comprehensive evaluation on 68 standard benchmark images that were not used for training revealed that the trained model-algorithm combination obtains improved denoising performance compared to the equivalent MRF model while being thousands of times faster.Section II presents an overview of Markov Random Fields, Energy Based Models and introduces the Active Random Field concept.
Section III applies the Active Random Field to image denoising using the Fields of Experts model, presenting a detailed overview of the training procedure and results.
Finally, Section IV presents conclusions and future directions.A shorter version of this paper appeared in CVPR [2].
Markov Random Fields (MRF) are used extensively in many areas of computer vision, signal processing and beyond.
They are capable of enforcing strong regularization on the desired results.
Let G = (V, E) be a graph with nodes V and edges E, x = (x v ) v∈V be a set of random variables representing some hidden attributes (e.g. labels) of the graph nodes v ∈ V , and C be a set of cliques (fully connected subgraphs) of G.
In a Bayesian framework, the posterior probability of the hidden variables x given input data (image, signal) y isP (x|y) ∝ P (y|x)P (x)(1)The Markov Random Field (C, φ) models the prior on the hidden variables xP (x) = 1 Z exp[ c∈C φ c (x c )](2)where φ c (x c ) are potential functions that enforce the regularization between the variables x c corresponding to the clique c.
The cliques can be as small as graph edges (order 2), however larger cliques are preferred, since they are capable of representing more complex relationships.
In our denoising application, the graph G is the pixel lattice and the clique set C contains all the 5 × 5 pixel patches of the image, thus each clique c ∈ C contains 25 nodes.Quite recently, Conditional Random Fields (CRF) [18], [17] were developed as an extension of the MRF so that the clique potentials depend on the observed data y.
A CRF is also a pair (C, φ) with φ depending on y, aimed at directly modeling the posterior P (x|y) (thus the task that is being solved).
P (x|y) = 1 Z(y) exp[ c∈C φ c (x c , y)](3)The MRFs and CRFs have the following advantages and disadvantages:+ They are capable of encoding complex relationships between the graph attributes x resulting in flexible yet powerful models -Inferring the optimal state is computationally demanding.
For example, the exact inference is NP hard [5] even for one of the simplest pairwise MRF priors: the Potts model [28].
Hence, approximate solutions are used in practice.
-The MRF is difficult to train, since the normalization constant Z is needed to comparing different MRF models.
-The the MRF/CRF is always used with an inference algorithm, as shown in Figure 1.
However, the MRF/CRF is usually trained independently of the inference algorithm, through a procedure illustrated Figure 2.
We will observe that by training the MRF/CRF together with the inference algorithm, significant improvements in both speed and accuracy can be obtained.
Recent work on Energy Based Models [1], [19], [25], [35] deals with the normalization constant by training the MRF parameters θ so that the MAP estimates are as similar as possible to the corresponding desired outputs.
The differences between the MAP estimates x i and the desired outputs t i are measured using a loss function L(x i , t i ) and the training procedure for the Energy Based Models can be written as:min θ i L(x i , t i ), with x i = arg max x p(x|y i ; θ) (4)This approach eliminates the need to compute the normalization constant by comparing models using the loss function.
However, these methods still deal with an idealized situation, since in reality the minimum energy MRF point is often too expensive to compute (e.g. NP-hard for the Potts model) obtaining a suboptimal point instead.
Since most fast inference algorithms obtain a sub-optimal solution anyway, we follow [39] and propose a different approach in which the model parameters are trained such that the inference algorithm output (and not the "ideal" MAP estimate as in the Energy Based Models) is close to the desired output.
This way, the suboptimal inference algorithm is involved in the parameter learning phase.
This combined approach can be written as: where x = A(y, θ) is the result of the algorithm A with the model and algorithm parameters θ = (θ m , θ a ) on the input image y.
As with the Energy Based Models from Section II-B, the training data consists of pairs (y i , t i ) consisting of input images y i and the corresponding desired outputs t i .
This approach is illustrated in Figure 3.
Since the MRF model and the inference algorithm are now inseparable, we define an Active Random Field (ARF) as a triplet (C, φ, A) consisting of a MRF or CRF (C, φ) together with an inference algorithm A ∈ A.
The algorithm A is selected from a family of algorithms A that provides inference on the input data y using the model (C, φ).
The algorithm family A can include any type of algorithm that can be used for MRF/CRF inference: gradient descent, Belief Propagation [44], Graph Cuts [5], etc.
However, in contrast to the standard MRF/CRF approaches, the algorithms in the family A are restricted to be very fast, by sacrificing accuracy.
For example, the number of gradient descent iterations in our image denoising application is kept small, on the order of 1 to 4, as opposed to 3000-10000 iterations used in [29].
The inaccuracy of the algorithm is compensated by training the model to give best results on this algorithm, resulting in a fast and accurate combination.min θ i L(x i , t i ), with x i = A(y i , θ)(5)The performance of the Active Random Field is measured using a loss function L that is a generally accepted benchmark in the community.
In image denoising we use the average PSNR (peak signal-to-noise ratio) over the set of images (training or testing) and replace the minimization in Equation (5) with a maximization.
Other more appropriate loss functions could be used instead of the PSNR, for example the Structural Similarity Index (SSIM) [40].
The differences from the standard MRF/CRF approaches and the proposed ARF approach are 1) The normalization constant Z is not important in the ARF since different models are compared using the loss function L instead of the likelihood or posterior probability.2) The training set consists of pairs of input images and desired results.
With the loss functions, this avoids the need for sampling from the learned distribution as in the MRF/CRF training.
The new training approach gives a better idea on when the training is completed or whether overfitting occurs.3) The trained model and algorithm complement each other and result in a fast and accurate system.
4) The MRF/CRF are just models that are always used with the help of an inference algorithm.
On the other hand, the ARF is a trained model+algorithm combination that given an input, returns a result, thus it is a full computational solution.
In the literature, a substantial amount of work combines models with algorithms in different ways.
Active Appearance Models [8] are iterative algorithms driven by data and a PCAlike model to find objects of interest in the image.
The solution depends on the starting location, so they are usually used in cooperation with other algorithms or with user initialization.
A more complete solution for object or shape detection is offered by the Shape Regression Machine [46], where an image based regression algorithm is trained to find a vector toward the object of interest from any random location inside the image.
Fast and robust object detection is obtained by using hundreds of random initializations and a verification step based on Adaboost.
The Shape Regression Machine can thus be seen as a trained model-algorithm combination for object or shape detection.
Our work differs from the Regression Machine because it is aimed at training models and algorithms for MRF/CRF inference instead of object/shape detection.
Another related work is [12], learning detectors for faces and face parts by exploiting the context between them, but without an explicit MRF formulation.The ARF resembles the energy based models [19], [25], in that only the energy part of the MRF is used without the normalization constant, and a loss function is used for training.
The energy based models are models trained in such a way that the minimum energy is at the desired location on the training set, independent of the optimization (inference) algorithm used.
In order for that to happen, specific conditions on the energy function are imposed [19].
By contrast, the ARF training finds the model parameters that give best results on a training set using a preselected inference algorithm.
As a consequence, no conditions on the energy function or the loss function are imposed on the ARF.
The applicability of the ARF is only limited by the existence of a fast inference algorithm that obtains results in a matter of seconds, since it will have to be applied many times during training.A number of works use the model-algorithm combination for learning the model, but without imposing any computational complexity constraints.
In this category is [36], where a CRF based on pairwise potentials is trained for object classification using boosting and a pixelwise loss function.
On a similar note, [37] trains a sequence of classifiers for object segmentation.
Each classifier is based on features from the data and on the probability map obtained so far.
These two methods train MRF model-algorithm combinations that slowly decrease in speed at each training iteration, because the models become more and more complex.
In [30], an approximate posterior was maximized by gradient optimization for learning a pairwise MRF for stereo matching.There exist a number of works that train model-algorithm combinations with a loss function that is used to report the results.
However, these works use inference algorithms that are focused on exact MAP estimation, which is different than what is proposed in this paper.
The same quantity from Eq.
(5) is minimized in [34] for image denoising, but as an attempt to obtain a stronger MRF optimum than the gradient descent.
For that, a more complex inference algorithm, based on variational optimization, is derived.
On a similar note, in [33] Gaussian Conditional Random Fields are defined and used for image denoising.
They allow exact computation of the MAP solution as well as an analytic gradient of a loss function (the MSE) comparing the solution and the desired result.
The analytic computation of the MAP solution and of the gradient are possible by making some compromises in the model (the GCRF).
The results presented in [33] are comparable to the two iterations of ARF though obtained at least one hundred times slower.
We show in Section III-F that MAP estimation for the Fields Of Experts MRF model can be obtained by a sequence of GCRF estimations.
Finally, a model-algorithm combination for optical flow was trained in [20] using stochastic optimization and a loss function based on the average endpoint error.
The MRF model was based on 3-cliques and inference was obtained by limited memory BFGS [21].
A common theme in these works is the fact that all use a lot of computation in the inference algorithm for obtaining an strong MRF optimum.
This paper differs in this regard by using a fast (close to real-time) and suboptimal inference algorithm which does not try to obtain a strong optimum.
We argue in this paper that it is more important to prevent overfitting than to obtain a strong MRF optimum.Even when using a fast inference algorithm such as one iteration of gradient descent, through appropriate training and with a complex and flexible enough model, the model will adapt to the simple descent algorithm as predicted by [39].
Consequently, the image denoising results presented in this paper surpass any previous results based on MRF models in both speed and accuracy.Similar goals in obtaining good results with low computational expense are explored in cost-sensitive learning.
In [38], a decision tree was trained to minimize a cost function with terms for accuracy and computational expense for each feature.
Also related is [42], where for each instance of the wellknown SAT problem, the most efficient algorithm is selected from a pool of SAT solvers using regressors that estimate the algorithm running time.
These regressors have been trained beforehand on a dataset of SAT instances.In general, parameter tuning for a specific application based on a training dataset can be viewed as related work, but we are unaware of any work specifically aimed at studying parameter tuning and ways to prevent overfitting.
Training of the Active Random Field, is achieved using examples in the form of pairs (y i , t i ) of the observed images y i and the corresponding desired outputs t i .
Given a training set T = {(y i , t i ), i = 1, ..., n} consisting of such pairs, the loss function L(y, t) is used to evaluate how well the model and algorithm solve the given problem on this training set.If the model-algorithm combination is parametrized by θ = (θ m , θ a ), the training is an optimization procedure to findθ = arg min θ n i=1 L(A(y i , θ), t i )(6)Depending on the problem, different optimization algorithms (coordinate descent, conjugate gradient, simulated annealing, genetic algorithm, etc) could be appropriate.There are two main concerns regarding this Active Random Field approach.1) The main concern is overfitting the training data.
This happens when an increased performance on the training data is reflected in a decreased performance on an unseen dataset.
Overfitting can be detected using a validation set and appropriate measures can be taken.
Possible measure include increasing the number of training examples or changing the type of the training examples (e.g. larger images to avoid boundary effects).
2) Another concern is the computational complexity of the applying the algorithm on all the training examples for each optimization iteration.
This concern is addressed in three ways.
First, for certain problems, different design strategies (e.g. memorization of partial results) can be used to reduce the computation to a fraction of the full evaluation cost.
Second, efficient optimization algorithms such as conjugate gradient or genetic algorithms, can make good use of each function evaluation.
Third, the computational demand is less of an issue every day due to the exponential growth in computational power of a standard PC.
Even though the CPU frequency has reached a limit recently, the number of CPU cores in a standard PC still increases exponentially.
Furthermore, the training can be easily parallelized, resulting in a good utilization of all available computing power.
We apply the ARF idea to image denoising, where given an image corrupted with noise, the goal is to obtain an image from which the noise was removed.
This problem has been addressed using wavelets in [27], [26] and by learning a MRF prior model known as Fields of Experts on 5 × 5 pixel cliques in [29].
Non-local image denoising methods include [6] and especially 3D collaborative filtering (BM3D) [9], the latter obtaining very good results with low computational expense.
An example of an image denoising problem and results obtained using the above mentioned methods as well as the ARF approach proposed in this paper are shown in Figure 4, together with the CPU time required to obtain each result.
Another approach [10] uses a sparse representation based on a learned dictionary of primitives and is more computationally expensive.
The ARF approach to image denoising proposed in this paper uses the Fields of Experts MRF model and the gradient descent algorithm that were presented in [29] and will be briefly mentioned in the next section.
The loss function used for training the ARF is the average PSNR (Peak Signal to Noise Ratio) over the training set.
The Fields of Experts [29] is a Markov Random Field prior model with potential functions based on a collection of convolution kernels (filters) J f , f = 1, ..., N and coefficientsα f , f = 1, ..., N p F OE (x, θ) = 1 Z(θ) exp(−E F OE (x, θ)), E F OE (x, θ) = k N f =1 α f log(1 + 1 2 (J T f x (k) ) 2 )(7)The first sum is taken over the cliques k of the denoised image x, and x (k) are the pixels of x corresponding to clique k.
There is a clique centered at each pixel location inside the image.
Basically, each expert is a convolution followed by a robust potential function.
A convolutional approach is also taken in the FRAME model for texture modeling [47].
This is a Maximum Entropy Model with learned potential functions and convolutions of the image with predefined filters such as Laplacian of Gaussian, Gabor, etc.
The difference is that in the FRAME model the convolution filters are predefined and the potential functions are learned, while in the FOE the potential functions are fixed and the convolution filters are learned.For image denoising, this prior is used together with a likelihood that assumes i.i.d. Gaussian noise:p(y|x) ∝ exp(−E data (x|y)), E data (x|y) = 1 2σ 2 j (y j −x j ) 2(8)where x j is the value of pixel j of image x.The beauty of the Fields of Experts formulation consists of an analytical solution for the gradient of the energy with respect to x.∇ x E F OE (x, θ) = N f =1 α f J − f * J T f x 1 + 1 2 (J T f x) 2 ∇ x E data (x|y) = 1 2σ 2 (x − y)(9)where J − f is the mirror image of filter J f around its center pixel.Given a noisy image and learned parameters θ, the denoising is obtained by gradient descent in the energy E data (x|y) + E F OE (x, θ).
Thus, by taking small steps in the direction of the energy gradient, a denoised imagê x is obtained in about 3000 iterations.
For more details, see [29].
In the Fields of Experts formulation, the model (MRF prior +likelihood) is trained independently from the MAP inference algorithm (gradient descent).
In what follows, they will be trained together in a joint optimization.For image denoising with Active Random Fields, we use the model and family of algorithms A from the Fields of Experts formulation presented above.
By ignoring the normalization constant, from the gradient equation (9) we obtain the iterative gradient descent inference algorithm that is used for MAP estimation.x ← x + δ β 2σ 2 (x − y) + N f =1 α f J − f * J T f x 1 + 1 2 (J T f x) 2(10)These iterative algorithms from equation (10) form an algorithm family A, parametrized by N convolution kernels J f , f = 1, ..., N with corresponding coefficients α f , the data coefficient β, the number n iter of gradient update iterations (10), and the update parameter δ.
Therefore θ = (θ m , θ a ) = (N, J 1 , α 1 , ..., J N , α N , β, n iter , δ).
(11) When training for a particular noise level σ, we observed a very modest contribution of at most 0.01dB of the data term β 2σ 2 (x − y) to the final result.
Hence we keep β = 0 until section III-E.
In our approach, instead of taking n iter = 3000 iterations with small steps (δ = 0.2) as in the FOE model, the algorithms in the family A have a small number of iterations n iter ∈ {1, 2, 3, 4} with δ = 400/n iter .
Since the number of iteration is small, the result is obtained between 800 and 3000 times faster than the FOE.
At the same time we observe that the denoising performance actually increases compared to FOE for an appropriately trained system.
In [29], the Fields of Experts model is trained using Contrastive Divergence [15] and Markov Chain Monte Carlo sampling.
The procedure involves gradient descent in the parameter space to minimize the KL divergence between the model probability and the empirical prior probability obtained from the training examples.
The parameters are updated based on expected values with respect to the current probability distribution, obtained using MCMC sampling.
The training procedure is computationally intensive and yields a generic prior model for natural images.In [34], the same FOE model is used and trained using a loss function and stochastic gradient descent.
With the help of a family of upper bounds of the nonlinear function log(1+x 2 ), another inference algorithm is obtained, with the hope that it can obtain a stronger optimum than the gradient descent (10).
In what follows, we will show that this is not necessary, since by appropriately training the ARF (i.e. the FOE model together with the steepest descent algorithm), the model will adapt to make the simple gradient descent work very well, making it unnecessary to use a more powerful inference algorithm.
This was predicted by Wainwright in [39] but the extent to which this statement is true is quite surprising.1) Dataset: The same images as [29] are used for training, namely 40 natural images from the Berkeley dataset [22].
The training examples consist of the 40 pairs (y i , t i ) of input images y i and desired results t i , i = 1, ..., 40.
The desired results t i are the original noise-free training images.
The input images y i are the original training images t i corrupted with Gaussian noise of similar variance as expected at testing time.
Since each training example contains 150, 000 cliques, the training set contains 6, 000, 000 cliques.
We experimented with smaller patches (e.g. of size 15 × 15 as in [29]) and observed that overfitting occurs when the patches are smaller than 250×250 pixels.
This could be due to the boundary effect since the graph nodes close to the patch boundary don't have all the neighbors to communicate with and behave differently than the interior nodes.For testing, we use the same 68 natural images from the Berkeley dataset as [29] as well as some standard image denoising test images.
These testing images were not used for training.2) Loss Function: The ARF is trained by optimizing the same criterion that is used for evaluating the denoising system performance, namely the average PSNR over the images in the set.
Thus the loss function is L(x, t) = 20 log 10 (255/std(t − x))where std(t − x) is the standard deviation of the difference between the original image t and the denoised image x.
More appropriate loss functions could be used instead of the PSNR, for example the Structural Similarity Index (SSIM) [40].
Learning is an optimization on the parameters θ to maximizeM (θ) = 1 n n i=1 L(A(y i , θ), t i ),(13)the average PSNR obtained after running the denoising algorithm A(y i , θ) with parameters θ on the 40 training examples y i .3) Optimization: In this work, coordinate ascent was used for maximizing the loss function.
Coordinate ascent is a greedy iterative optimization algorithm in which at each step, one of the variables θ i of the current state θ is chosen at random and its value is modified by a small amount (0.0001 to 0.001 in our experiments) if M (θ) does not decrease.
If the M (θ) decreases, the variable θ i is rolled back to its old value.
For our problem, each filter is constrained to have a zero-sum so we modified the coordinate ascent so that when a filter is selected to be modified, two locations inside the filter are chosen randomly and modified by the same small amount, but with opposite signs.
This way the filters always remain zerosum.We also experimented with gradient ascent, conjugate gradient and the simplex method [24].
For this particular application, we observed that these other methods could not find such a strong optimum as the coordinate ascent.
This is probably because the optimum path is very narrow and a fast algorithm could not follow it properly.
Other optimization methods such as genetic algorithms [14] or simulated annealing [16] could be more appropriate for avoiding local optima and are subject to further investigation.
The one iteration parameters were trained first, for the level of noise σ = 25.
For the one iteration parameters, the coefficients α f can be well approximated analytically as the solution of the least squares problem:40 i=1 ||t i − x i − δ N f =1 α f g i f || 2 ,where(g i f ) j = J − f * J T f x (j) i 1 + 1 2 (J T f x (j) i ) 2(14)This leaves only the value of the filters F f , f = 1, ..., N for optimization.
At each step of the optimization, the coefficients α f are obtained by solving the above least squares problem and then M (θ) is evaluated.
This technique is know as RaoBlackwellization [4], [7].
Since the function M (θ) is not convex, the optimization is prone to be stuck in local maxima.
To alleviate this problem, the one iteration filters for σ = 25 are trained using a simplified version of Marginal Space Learning [45].
Marginal Space Learning is an optimization procedure aimed at finding optima in high dimensional spaces by propagating a set of particles in a sequence of spaces of increasing dimensions until the full parameter space is reached.
In our case, a Fig. 8.
PSNR evolution on the training and test set observed while training the one iteration (n iter = 1) ARF parameters for the level of noise σ = 25.
Also displayed in dotted lines are the training and testing PSNR of a GMRF with the same model complexity, described in section III-G.
single particle (maximum) is propagated starting from the small dimensional space of parameters of only one filter and gradually increasing the dimensionality by adding filters or by increasing the filter size.
Each time the dimensionality is increased, the position of the particle in the larger Marginal Space is searched by Coordinate Ascent.More specifically, the Marginal Space Learning procedure is started with one filter of size 3 × 3 with all entries 0 except on the first row, F 1 (1, 1) = 0.1, F 1 (1, 2) = −0.1.
Starting from this initial setting, the PSNR optimization was run until not much improvement in M (θ) was observed.
This is the location of the particle in the first Marginal Space.
Then the parameter space was enlarged by adding another filter with all entries 0 and optimizing for 3000 steps, obtaining the particle position in the second space.
The process of increasing the Marginal Space by adding one filter and retraining was repeated until there were a total of five 3 × 3 filters.
Then the Marginal Space was enlarged by increasing the filter size to 5 × 5 by padding zeros on the border of each filter.
The new position of the particle (maximum) was searched through 3000 steps of optimization.
The process of enlarging the Marginal Space by adding filters (now of size 5 × 5) and retraining was repeated until the number of filters reached N = 13.
Thisnn iterr =11 σσ =155 nn iterr =22 σσ =155 nn iterr =11 σσ =100 nn iterr =22 σσ =100 nn iterr =11 σσ =200 nn iterr =22 σσ =200 nn iterr =11 σσ =255 nn iterr =22 σσ =255 nn iterr =11 σσ =500 nn iterr =22 σσ =500 nn iterr =33 σσ =100 nn iterr =44 σσ =100 nn iterr =44 σσ =155 nn iterr =33 σσ =155 nn iterr =33 σσ =200 nn iterr =44 σσ =200 nn iterr =44 σσ =255 nn iterr =33 σσ =255 nn iterr =33 σσ =500nn iterr =44 σσ =500 Fig. 9.
Diagram of the training of the ARF parameters for different levels of noise and numbers of iterations of the steepest descent inference algorithm.
The double lines mean that the filters are the same.
number was chosen by observing on the validation set that no further improvement in PSNR could be obtained.
The whole procedure is illustrated in Figure 7.
The evolution of the PSNR over all this training, starting with one 3 × 3 filter and ending with thirteen 5 × 5 filters is plotted in Figure 8.
Training the 5 filters of size 3 × 3 takes about 7 hours on a dual-core 2.4Ghz PC while the whole training for the one iteration σ = 25 filters takes about 3 days.Since the optimization is prone to be stuck in local optima, the other filters are initialized from already trained filters in the order presented in Figure 9.
The 3-iteration filters are well trained to perform iterative denoising and can also be used for 4-iterations without any modifications.Training each of the arrows in Figure 9 takes about one day on a 8-core 2Ghz PC.
We believe that by using better optimization algorithms, the training time can be further improved.
The trained 5 × 5 filters for σ = 20 and n iter = 3 are shown in Figure 5.
4) Overfitting: As already mentioned, we initially used images of size 15×15 as in [29] and observed that the training PSNR was increasing significantly while the PSNR on the validation set was actually decreasing, a sign of overfitting.
We experimented with increasing the size of the training images and observed that this alleviated the overfitting problem.
Finally we observed that when the training images were at least 250 × 250, there were no signs of overfitting.
The performance of the Active Random Field system is evaluated on the same datasets as [29].
First, results on some standard images -Lena, Barbara, Boats, House and Peppersat the noise level σ = 25 are shown in Table I. Note that these images were not used for training.
The ARF results are obtained between 7 and 3000 times faster than the other methods.For further comparison, Table II and Figure 10 present results on the same 68 test images from the Berkeley dataset as [29].
Note that these images were also not used for training.
We present results for 1: Wiener filter, 2: Nonlinear Diffusion [41] using the nonlinear diffusion Matlab toolbox provided by Frederico D'Almeida, with parameters λ = 8, σ = 1, diffusivity = 3, step size = 8, steps = 2, and with the aos option, 3: Non-local means [6] with search window 17 × 17, similarity window 9 × 9 and h tuned for best results for each σ, 4: Fields of Experts (FOE) [29] with 3000 iterations, 5,6,7,8: our algorithm with 1,2,3,4 iterations, 9: wavelet based denoising [27], 10: Overcomplete DCT [10], 11: KSVD [10] and 12: BM3D [9].
Since this evaluation is on 68 images, it should be regarded as a more thorough evaluation than the results on 5 specific images.
We should mention that all other algorithms were run on Matlab code provided by their authors and were not implemented by us.From the evaluation, it is clear that the one iteration ARF is on par with the FOE while being 3000 times faster.
Therefore, training the MRF model together with a suboptimal inference algorithm offers significant advantages in speed and accuracy.
One could also observe that the ARF is within 0.5dB from the best method and it is outperformed by two methods: KSVD [10], BM3D [9] and for some noise levels by wavelet denoising [27] and overcomplete DCT [10].
Depending on application, trade-offs between speed and accuracy might be important.
Figure 11 shows a plot of the PSNR performance in dB of the algorithms compared above as a function of the processing speed in fps.
From the figure, one can see that the Active Random Fields are very competitive candidates when high processing speeds are required such as in real-time medical applications.The computation complexity of the ARF image denoising algorithm is due to the necessity of performing 2N convolutions (where N is the number of filters) for each iteration.
A standard Matlab implementation takes about 0.8s for each iteration on a 256×256 image and a 2.4GHz PC.
A better C++ implementation using IPL (Intel Image Processing Library) Table II.
cuts computation time to 0.12s per iteration for the same image size.
Furthermore, a parallel implementation on multiple CPUs and/or a GPU implementation could bring this algorithm to real-time performance.
It is intriguing that such results could be obtained in a single gradient descent iteration.
Could this be due to the specially trained filters F j or to the filter coefficients α j ?
In this section we perform more experiments on different one iteration algorithms to determine the cause of this performance.
First, we plot in Figure 12 the performance of the 1-iteration ARF in the range σ ∈ [10,50].
For comparison, the FOE performance is also displayed.
It is clear that the ARF algorithms are specialized at the levels of noise they were trained for.Then we evaluated the FOE model with a single iteration gradient descent algorithm on the same 68 images from the Berkeley dataset, choosing the step size δ to maximize the PSNR.
The results are presented in the second row in Table III and in Figure 13.
Another 1-iteration FOE model was obtained by retraining the coefficients α j for each σ to maximize the PSNR on the training data, while keeping the original filters F j .
These results are posted in the third row in Table III and in Figure 13.
For each algorithm are also displayed in Table III the number of parameters that are trained for each noise level σ.The fourth row of the table displays an evaluation of the FOE filters when the filter norms ν j (i.e. scalar multipliersF j = ν j F F OE j) and their coefficients α j were trained for each value of σ by maximizing the PSNR on the training set.The fifth row in Table III presents the performance of a 1-iteration ARF that was trained on images corrupted with noise levels σ = 15 and 25 and no data term.
Observe that the performance decreased slightly while the noise range was extended.In the 1-iteration ARF, the data term has theoretically no influence, since before the iteration x − y = 0.
We slightly modified the 1-iteration ARF to a 2-step version that bears the same computational expense but can take into account the data term:1.
x ← y + δ N f =1 α f J − f * J T f y 1 + 1 2 (J T f y) 2 2.
x ← x + δ β σ 2σ 2 (x − y)(15)where the data term has a coefficient β σ that depends on σ, as in [29].
This can be also written in a single iteration asx ← y + δ N f =1 α f (1 + β σ 2σ 2 )J − f * J T f y 1 + 1 2 (J T f y) 2 (16)The last two rows of Table III and the red and green solid lines in Figure 13 show results obtained with this modified 1-iteration ARF.
The first one is trained with images corrupted with noise levels σ = 15 and 25, while the second one with images corrupted with noise levels σ = 15 and 40.
One can see that the band-pass behavior disappeared after the introduction of the data term.The FOE with the coefficients and norms retrained at each noise level (fourth row in Table III) has a very good overall performance.
However, compared to the ARF algorithms displayed in Table III, it has 48 times more parameters (24 norms and 24 coefficients) that are trained at each noise level.
In this section we will use a standard statistical method named M-estimation [11], p. 99, which maps robust regression to an iterative weighted regression.The FOE energy with a data term can be written as:E F OE (x) = N f =1 j α f ρ(J T f x (j) ) + β(x − y) T (x − y) = N f =1 j α f ρ(J T f,j x) + β(x − y) T (x − y)(17)where ρ(x) = log(1 + x 2 /2) is the Lorentzian and J f,j is the j-th column of J f .
Thus minimizing E F OE (x) means solving a robust regression problem.
One commonly used algorithm for robust regression is the iterative weighted regression using M-estimation, [11], p. 99.
Taking the derivative with respect to x (k) and setting it to zero, gives: Filter responses, sigma=25 which can be written as∂ ∂x (k) E F OE (x) = N f =1 j α f ρ ′ (J T f,j x)J f,j,k +2β(x−y) = 0,(18)N f =1 j α f 1 1 + (J T f,j x) 2 /2 J f,j,k J T f,j x + 2β(x − y) = 0 (19)By fixing w j,f = α f /(1 + (J T f,j x) 2 /2), observe that (19) can be regarded as solving (minimizing) the weighted least squaresE w (x) = N f =1 j w jf (J T f,j x) 2 + β(x − y) T (x − y)(20)This leads to a fixed point solution to the M-estimation problem by starting with an initial x = x 0 and iteratively minimizing (20) and updating the weights w j,f = α f /(1 + (J T f,j x) 2 /2) based on the newly obtained x.Since the weighted sum of squares from eq.
(20) is exactly the energy of a Gaussian Conditional Random Field [33] E GCRF (x) = N f =1 j w f (y) (j) (J f * x (j) − r f (y) (j) ) 2 (21)we obtain that the FOE energy can be minimized in an iterative way by alternatively minimizing a GCRF energy (20) and updating the weights as described above.In the ARF approach presented in this paper, a simpler approach to minimizing the FOE energy is taken as a few iterations of gradient descent.
This eliminates the need to solve costly least squares problems and it works very well.
Finally, to see how close the one iteration ARF is to exact inference on a Gaussian MRF with energyE GRF (x) = x T Σ −1 x + (x − y) T (x − y),(22)we get the exact minimum atˆx atˆ atˆx = (2Σ −1 + I) −1 y = Ay.By limiting to only short-range interactions, (23) can be seen as a filtering operationˆxoperationˆ operationˆx = F * y.(24)Comparing this to the one-iteration ARF equation e.g. (16), the Gaussian MRF solution above (24) is linear whereas the one iteration ARF is non-linear.
To see how close the one iteration ARF is to being a linear operator, we obtained a histogram of the filter responses over the test set, displayed in Figure 14.
Approximately 8% of the filter responses fall outside the interval [−1, 1] where the Lorentzian ρ(x) = log(1 + x 2 /2) can be well approximated with a Gaussian, i.e. where the derivative ρ ′ (x) (overlaid as a dashed curve in Figure 14) is approximately linear.To compare how well the GMRF can denoise with the same model complexity, we trained it on the same 40 images from the Berkeley dataset.
We used the same Marginal Space Learning approach as for training the ARF, but now there is only one filter that is started as the 1 × 1 identity filter and is enlarged by placing zeros on the border followed by 3000 iterations of coordinate ascent with the same PSNR loss function as the ARF.
The enlarging and 3000 iteration optimization were alternated until the filter had size 19 × 19, which has slightly more parameters as 13 FOE filters of size 5 × 5.
The PSNR on the training and test set are plotted in Figure 8.
One could see that the Fields of Experts has better modeling power and it is better suited for image denoising, achieving more than 1.5dB improvement when compared to the GMRF.
Wainwright [39] predicted that in computationally restricted applications, models trained using MAP estimation might not be the best choice and biased models might give better results.
In this paper, we studied what biased models can give us for real-time image denoising.
We defined Active Random Field as the combination of a MRF/CRF with a fast and suboptimal inference algorithm and trained this combination using pairs of input and desired output as well as a benchmark error measure (loss function).
This training approach does not need to evaluate the MRF normalization constant and can use a validation set to detect when the training is completed and whether overfitting occurs.Applied to image denoising, experiments show that considerable gains in speed and accuracy are obtained when compared to the standard MRF formulation.
Moreover, the obtained results are comparable in terms of accuracy with the state of the art while being faster.A direct practical application of this method is denoising fluoroscopy (X-ray) sequences, where one could use pairs of low-dose (noisy) and high-dose (good quality) X-rays obtained from cadavers or phantoms to train a similar Active Random Field based real-time image denoising system.
This type of training can be used in other applications where fast MRF inference is desired on models with a large number of parameters, for example super-resolution [13], [43].
If the number of model parameters is small, the model might not be flexible enough to adapt to the fast inference algorithm.
